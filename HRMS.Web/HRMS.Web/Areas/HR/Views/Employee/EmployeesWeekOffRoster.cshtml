@using Microsoft.AspNetCore.Http;
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@using HRMS.Models;
@using HRMS.Models.Common;
<link href="~/assets/pages/gridlist.css" rel="stylesheet" />

@model HRMS.Models.Common.Results
@{
	Layout = String.Format("~/Areas/{0}/Views/Shared/_Layout.cshtml", @HttpContextAccessor.HttpContext.Session.GetString(HRMS.Models.Common.Constants.AreaName));
	var RoleName = Convert.ToInt64(this.Context.Session.GetString(Constants.RoleID));

	ViewData["Title"] = "Employee";

	var success = TempData["Success"];
	var Err = TempData["Error"];
}
 
<div class="main-header anim" style="--delay: 0s">
	Employee Roster List
	<section class="right-button-employee">
		<a href="~/HR/employee/AddUpdateWeekOffRoster"> <button type="button" class="btn btn-addBtn" id="openFormBtn">Add WeekOff</button></a>
		<a href="~/Admin/Dashboard/UploadRosterExcel"> <button type="button" class="btn btn-addBtn" id="openFormBtn">Import WeekOff Roster</button></a>
	</section>
</div>

<!-- Year & Month Dropdowns -->



<div class="table-responsive py-3">
	<div class="row mb-3">
		<div class="col-md-2">
			<label for="yearDropdown">Year</label>
			<div class="custom-select-wrapper">
				<select class="form-select custom-select" id="yearDropdown"></select>
			</div>
		</div>
		<div class="col-md-4">
			<label for="dayDropdown">Week</label>
			<div class="custom-select-wrapper">
				<select class="form-select custom-select" id="weekDropdown"></select>
			</div>
		</div>
	</div>
	<table id="tblEmployeeWeekOffListing" class="table table-striped body-text" style="width:100%">
		<thead>
			<tr>
				<th> </th>
				<th>Emp No</th>
				<th>Employee Name</th>
				<th>WeekOff 1</th>
				<th>WeekOff 2</th>
		@* 		<th>WeekOff 3</th> *@
				<th>Modified By</th>
				<th>ModifiedDate</th>
				 <th>Action</th>
			</tr>
		</thead>
	</table>
</div>

<script type="text/javascript">
	let weekVal = null;
	let selectCurrentWeek = true;

	 function populateWeekDropdown(year) {
		const weekDropdown = $('#weekDropdown');
		weekDropdown.empty();
		weekDropdown.append($('<option>').val('').text('-- Select Week --'));

		const weekRanges = getWeekRanges(year);
		const today = new Date();
		let selectedValue = null;


		weekRanges.forEach(w => {
			const label = `Week ${w.weekNumber} (${w.startDate} - ${w.endDate})`;
			const value = `${w.weekNumber}|${w.startDate}|${w.endDate}`;


			  const start = new Date(convertToISO(w.startDate));
		const end = new Date(convertToISO(w.endDate));


		  if (today >= start && today <= end) {
			selectedValue = value;
		}


		

			weekDropdown.append($('<option>').val(value).text(label));
		});


		if (selectCurrentWeek && selectedValue) {
		weekDropdown.val(selectedValue).trigger('change');
		weekVal = selectedValue; // store it for DataTable ajax
		selectCurrentWeek = false; // only auto-select once
	}
	}
	
	 function getWeekRanges(year) {
		const weeks = [];
		const firstMonday = getFirstMondayOfYear(year);

		let current = new Date(firstMonday);
		let week = 1;

		while (current.getFullYear() === year) {
			const start = new Date(current);
			const end = new Date(current);
			end.setDate(end.getDate() + 6);

			weeks.push({
				weekNumber: week,
				startDate: formatDate(start),
				endDate: formatDate(end)
			});

			current.setDate(current.getDate() + 7);
			week++;
		}


		const start = new Date(current);
		const end = new Date(current);
		end.setDate(end.getDate() + 6);
		if (start.getFullYear() === year) {
			weeks.push({
				weekNumber: week,
				startDate: formatDate(start),
				endDate: formatDate(end)
			});
		}

		return weeks;
	}
	   function getFirstMondayOfYear(year) {
		const date = new Date(year, 0, 1); // Jan 1
		const day = date.getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6
		const diff = (day === 0) ? 1 : (8 - day); // days to next Monday
		date.setDate(date.getDate() + (day === 1 ? 0 : diff));
		return date;
	}

	   function formatDate(date) {
		return date.toLocaleDateString('en-GB', {
			day: '2-digit',
			month: 'short',
			year: 'numeric'
		});
	}
	 function convertToISO(dateStr) {
		const parts = dateStr.split(' ');
		const day = parts[0];
		const month = {
			Jan: '01', Feb: '02', Mar: '03', Apr: '04', May: '05', Jun: '06',
			Jul: '07', Aug: '08', Sept: '09', Oct: '10', Nov: '11', Dec: '12'
		}[parts[1]];
		const year = parts[2];
		return `${year}-${month}-${day.padStart(2, '0')}`;
	}

	$(document).ready(function () {
		// Populate year dropdown and set current year/month
		var currentDate = new Date();
		var currentYear = currentDate.getFullYear();
		var currentMonth = currentDate.getMonth() + 1; // months are 0-based

		var yearDropdown = $('#yearDropdown');
		yearDropdown.append('<option value="">--Years--</option>');
		for (var y = currentYear; y >= currentYear - 0; y--) {
			var selected = (y === currentYear) ? 'selected' : '';
			yearDropdown.append('<option value="' + y + '" ' + selected + '>' + y + '</option>');
		}
		const selectedYear = parseInt($('#yearDropdown').val());
	    populateWeekDropdown(selectedYear);
	

		// Initialize DataTable
		var table = $('#tblEmployeeWeekOffListing').DataTable({
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "GetEmployeesWeekOffRoster/",
				"type": "POST",
				"datatype": "json",
				"data": function (d) {
					var pageNumber = Math.floor(d.start / d.length) + 1;
					var weekStart = null
	if (weekVal) {
		var parts = weekVal.split('|');
		weekStart = convertToISO(parts[1]); 
		
					}
                    var sortColumn = typeof d.order[0] !== 'undefined' ? d.columns[d.order[0].column].data : 'employeNumber';
                    var sortDirection = typeof d.order[0] !== 'undefined' ? d.order[0].dir : 'asc';
					return {
						sEcho: d.draw,
						iDisplayStart: d.start,
						iDisplayLength: d.length,
						sSearch: d.search.value,
						PageNumber: pageNumber,
						PageSize: d.length,
						Year: $('#yearDropdown').val(),
						WeekStartDate: weekStart,
                        sortCol: sortColumn,
                        sortDir: sortDirection
					};
				}
			},
			"ordering": true,
			"paging": true,
			"searching": true,
			"info": true,
			"columns": [
				{ "data": "id", "autoWidth": true, "visible": false },
				{ "data": "employeeNumber", "autoWidth": true },
				{ "data": "employeeName", "autoWidth": true },
				{
					"data": "dayOff1", "autoWidth": true,
					"render": function (data) { return formatDateCell(data); }
				},
				{
					"data": "dayOff2", "autoWidth": true,
					"render": function (data) { return formatDateCell(data); }
				},
				// {
				// 	"data": "dayOff3", "autoWidth": true,
				// 	"render": function (data) { return formatDateCell(data); }
				// },
				
				{ "data": "modifiedName", "autoWidth": true },
				{
					"data": "modifiedDate", "autoWidth": true,
					"render": function (data) { return formatDateTimeCell(data); }
				},
			{
					"data": null,
					"render": function (data, type, row) {
	 					var linkEdit = '<div class="table-data-feature">' +
	 						'<a data-toggle="tooltip" data-placement="top" class="item" href="AddUpdateWeekOffRoster?id=' + row.encryptedIdentity + '&emp=' + row.encryptedEmployeeId + '" title="Edit">' +
	 						'<img src="/assets/img/edit.png" width="20" height="20" />' +
							'</a></div>';

					var DeleteRecord = '<div class="table-data-feature">' +
	 '<a data-toggle="tooltip" data-placement="top" class="item delete-button" href="DeleteWeekOffRoster?id=' + row.encryptedIdentity + '" title="Delete">' +
 '<img src="/assets/img/delete.png" width="20" height="20" />' +
	 '</a></div>';


	 					return linkEdit + DeleteRecord;
	 				},
	 				"orderable": false,
	 				"className": "Edit-Button"
	 			}
			],
			"columnDefs": [
				{ "targets": [0], "orderable": false, "visible": false }
				
			],
			"responsive": true
		});

		// Reload table when dropdowns change
		$('#yearDropdown, #weekDropdown').change(function () {
			weekVal = $('#weekDropdown').val();
			table.ajax.reload();
		});
	});
		// Handle delete confirmation
	$(document).on('click', '.delete-button', function (e) {
		e.preventDefault(); // stop immediate navigation

		var url = $(this).attr('href');

		if (confirm("Are you sure you want to delete this WeekOff Roster record? ")) {
			window.location.href = url; // navigate if confirmed
		}
	});

	function formatDateCell(data) {
		if (!data) return "";
		const date = new Date(data);
		if (isNaN(date)) return data;
		const day = date.getDate().toString().padStart(2, '0');
		const month = (date.getMonth() + 1).toString().padStart(2, '0');
		const year = date.getFullYear();
		return `${day}-${month}-${year}`;
	}

	function formatDateTimeCell(data) {
		if (!data) return "";
		var date = new Date(data);
		if (isNaN(date)) return data;
		return date.toLocaleDateString('en-GB') + " " + date.toLocaleTimeString('en-GB', {
			hour: '2-digit',
			minute: '2-digit',
			hour12: true
		});
	}
</script>
