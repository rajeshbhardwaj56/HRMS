@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Configuration
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@inject IConfiguration _configuration
@{
	Layout = String.Format("~/Areas/{0}/Views/Shared/_Layout.cshtml", @HttpContextAccessor.HttpContext.Session.GetString(HRMS.Models.Common.Constants.AreaName));
	ViewData["Title"] = "Team Attendance Approval Report";
}
<style>
	span.L.status-badge {
		background: #053470;
	}

	.crm-loader-overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(255, 255, 255, 0.6);
		z-index: 1050; /* Above modals and Bootstrap elements */
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.crm-loader-inner {
		text-align: center;
	}

	.loader-text {
		font-size: 16px;
		color: #333;
	}

	body {
		background-color: #f8f9fa;
		font-family: Arial, sans-serif;
	}

	.HD {
		background: #04336f;
		cursor: pointer;
		/* border-radius: 27px; */
	}

	.status-badge {
		display: inline-block;
		padding: 3px 8px;
		border-radius: 12px;
		font-weight: 600;
		color: white;
		font-size: 0.9rem;
		min-width: 22px;
		text-align: center;
	}

	.P {
		background-color: #28a745;
		cursor: pointer;
	}

	.A {
		background-color: #dc3545;
		cursor: pointer;
	}

	.H {
		background-color: #1c5db1;
		cursor: pointer;
	}

	.table-warning {
		background-color: #fff3cd;
		color: #856404;
		font-weight: 700;
		cursor: pointer;
	}

	#pagination {
		justify-content: center;
	}

	#total-records-info {
		font-weight: 500;
	}

	.table-warning {
		background-color: #fff3cd !important;
		color: #856404 !important;
	}

	div#record-range-info {
		float: left;
	}

	div#pagination-container {
		float: right;
	}

	.filter-class {
		background-color: #ffffff;
		border-radius: 8px;
		padding: 12px 20px;
		box-shadow: 0 0 8px rgba(0,0,0,0.1);
		margin: 0 auto; /* center horizontally */
		float: right;
	}

	.filter-label {
		font-weight: 600;
		color: #444;
		font-size: 14px;
		white-space: nowrap;
	}

	.form-select {
		border: 1.5px solid #ced4da;
		border-radius: 6px;
		font-size: 14px;
		padding: 5px 10px;
		transition: border-color 0.3s ease;
	}

		.form-select:focus {
			border-color: #0d6efd;
			box-shadow: 0 0 4px rgba(13, 110, 253, 0.5);
			outline: none;
		}

	button#export-btn {
		background: #05397b;
		color: white;
		padding: 6px;
		margin-left: 14px;
	}

	.Show-filter-class {
		background-color: #ffffff;
		border-radius: 8px;
		padding: 12px 20px;
		box-shadow: 0 0 8px rgba(0,0,0,0.1);
		margin: 0 auto; /* center horizontally */
		float: left;
		margin-top: 23px;
	}
</style>


<div id="crm-loader" class="crm-loader-overlay d-none">
	<div class="crm-loader-inner">
		<div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
		<div class="loader-text mt-2">Loading, please wait...</div>
	</div>
</div>

<div class=" ">


	<div class="main-header anim" style="--delay: 0s">Team Attendance Approval Report</div>
	<!-- Filters Row -->
	<div class="d-flex flex-wrap align-items-end gap-3 mb-4 mt-4 p-3 rounded shadow-sm bg-white">
		<div class="d-flex align-items-center">
			<label for="page-size-select" class="me-2 mb-0">Show:</label>
			<select id="page-size-select" class="form-select" style="width: 100px;">
				<option value="10">10</option>
				<option value="20" selected>20</option>
				<option value="50">50</option>
				<option value="100">100</option>
			</select>
		</div>

		<!-- Search Input -->
		<div class="d-flex align-items-center" style="min-width: 300px;">
			<label for="search-box" class="me-2 mb-0">Search:</label>
			<input type="text" id="search-box" class="form-control" placeholder="Search by name or employee no..." style="max-width: 300px;">
		</div>





		<!-- Page Size -->
		<!-- Job Location Dropdown -->
		<!-- Export Button -->
		<div>

			<button id="bulk-upload-btn" class="btn btn-primary" style="height: 38px;"><i class="bi bi-upload"></i> Bulk Update</button>
		</div>

	</div>


	<div class="table-container">

		<table class="table table-bordered table-hover">


			<thead class="table-dark">
				<tr id="header-row">
					<th>Employee ID</th>
					<th>Emp No</th>
					<th>  Name</th>
					<th>  Location </th>
				</tr>
			</thead>
			<tbody id="attendance-data">
			</tbody>
		</table>
	</div>
</div>
<div id="total-records-info" class="text-center text-muted"></div>

<div class="Footerbar">
	<div id="record-range-info" class="text-center text-muted mb-2"></div>

	<div id="pagination-container" class="d-flex justify-content-center mb-2"></div>
</div>

<!-- Attendance Detail Modal -->
<div class="modal fade" id="attendanceDetailModal" tabindex="-1" aria-labelledby="attendanceDetailModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="attendanceDetailModalLabel">Attendance Details</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="attendanceDetailBody">
				Loading details...
			</div>
		</div>
	</div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
	let currentPage = 1;
	let pageSize = 20;
	let totalPages = 1;
	let isLoading = false;

	function showLoading() {
		$("#crm-loader").removeClass("d-none");
	}

	function hideLoading() {
		$("#crm-loader").addClass("d-none");
	}

	function renderAttendanceTable(response) {
		const data = response?.data?.attendances;
		if (!data?.length) return;

		const tbody = $("#attendance-data").empty();
		const thead = $("#header-row").empty();
		const firstRecord = data[0];
		const dayKeys = Object.keys(firstRecord.attendanceByDay);

		let headerHtml = `<th>Emp No</th><th>Name</th><th>Location</th><th>Date</th>`;
		dayKeys.forEach(day => headerHtml += `<th>${day.replace("_", " ")}</th>`);
		headerHtml += `<th>Status</th><th>Dialer Time</th><th>Remarks</th><th>Action</th>`;
		thead.html(headerHtml);

		data.forEach(record => {
	const date = new Date(record.workDate);
	const formattedWorkDate = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;

			let row = `<tr><td>${record.employeNumber}</td><td>${record.employeeName}</td><td>${record.jobLocationName}</td><td>${formattedWorkDate}</td>`;

			dayKeys.forEach(day => {
				let status = record.attendanceByDay[day];
				if (status === "Sa" || status === "S") status = "H";
				const className = status === "P" ? "P" : "";
				row += `<td class="${className}" data-date="${day.replace("_", "-")}" data-empid="${record.encryptedIdentity}" data-empno="${record.employeeNumberWithoutAbbr}">
							<span class="${status} status-badge">${status}</span>
						</td>`;
			});

			row += `
				<td>
						<select class="form-select attendance-status-dropdown"  style="border-radius: 5px;	">
						<option value="">Select</option>
						<option value="P">Present</option>
						<option value="A">Absent</option>
						<option value="HD">Half Day</option>
						<option value="WO">Week Off</option>
					</select>
				</td>
				<td><input type="text" class="form-control attendance-time" placeholder="Dialer Time"   /></td>
				<td><input type="text" class="form-control attendance-remarks" placeholder="Remarks"   /></td>
				<td>
					<button class="btn btn-sm btn-primary confirm-btn" data-empid="${record.encryptedIdentity}" data-empno="${record.employeeNumberWithoutAbbr}" data-datedata="${record.workDate}">Confirm</button>
				</td>
			`;

			row += `</tr>`;
			tbody.append(row);
		});
	}

	function renderPagination(current, total) {
		const $pagination = $("#pagination-container").empty();
		const maxPages = 3;
		let start = Math.max(1, current - Math.floor(maxPages / 2));
		let end = Math.min(total, start + maxPages - 1);
		if (end - start < maxPages - 1) start = Math.max(1, end - maxPages + 1);

		let html = '<nav><ul class="pagination justify-content-center">';
		html += `<li class="page-item ${current === 1 ? "disabled" : ""}"><a class="page-link" href="#" data-page="${current - 1}">Previous</a></li>`;
		for (let i = start; i <= end; i++) {
			html += `<li class="page-item ${i === current ? "active" : ""}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
		}
		html += `<li class="page-item ${current === total ? "disabled" : ""}"><a class="page-link" href="#" data-page="${current + 1}">Next</a></li></ul></nav>`;
		$pagination.html(html);
	}

	function fetchAttendanceData(page, search = "", overridePageSize = null, jobLocationId = 0) {
		if (isLoading) return;
		isLoading = true;
		showLoading();
		const effectivePageSize = overridePageSize ?? pageSize;
		$.ajax({
			url: '/employee/Attendance/TeamAttendenceForApprovalList',
			type: 'GET',
			data: {
				Page: page,
				PageSize: effectivePageSize,
				SearchTerm: search,
				JobLocationID: jobLocationId
			},
			dataType: 'json',
			success: function (res) {
				const jobList = res.data.joblocationList;
				const $ddl = $('#jobLocationDropdown');
				const selectedId = $ddl.val();
				$ddl.empty().append('<option value="">-- Select Job Location --</option>');
				$.each(jobList, (i, loc) => $ddl.append(`<option value="${loc.jobLocationID}">${loc.jobLocationName}</option>`));
				$ddl.val(selectedId);

				const total = res.data.totalRecords || 0;
				if (!total) {
					$("#attendance-data").html(`<tr><td colspan="100%" class="text-center text-muted">No records found</td></tr>`);
					$("#pagination").empty();
					$("#record-range-info").text("No records to display.");
					isLoading = false;
					hideLoading();
					return;
				}

				totalPages = Math.ceil(total / pageSize);
				renderAttendanceTable(res);
				renderPagination(page, totalPages);

				const start = (page - 1) * pageSize + 1;
				const end = Math.min(page * pageSize, total);
				$("#record-range-info").text(`Showing ${start} to ${end} of ${total.toLocaleString()} entries`);
				hideLoading();
				isLoading = false;
			},
			error: function (xhr, status, error) {
				console.error("Error fetching attendance data:", error);
				hideLoading();
				isLoading = false;
			}
		});
	}

	$(document).ready(function () {
		fetchAttendanceData(currentPage);

		$('#jobLocationDropdown').on('change', function () {
			currentPage = 1;
			fetchAttendanceData(currentPage, '', null, parseInt($(this).val()) || 0);
		});

		let searchTimer;
		$("#search-box").on("keyup", function () {
			clearTimeout(searchTimer);
			const text = $(this).val().trim();
			currentPage = 1;
			const override = text === "" ? null : 0;

			if (text.length === 0 || text.length >= 2) {
				searchTimer = setTimeout(function () {
					fetchAttendanceData(currentPage, text, null,  parseInt($("#jobLocationDropdown").val()) || 0);
				}, 300);
			}
		});

		$("#page-size-select").on("change", function () {
			pageSize = parseInt($(this).val());
			currentPage = 1;
			fetchAttendanceData(currentPage, '', null, parseInt($("#jobLocationDropdown").val()) || 0);
		});

		$("#pagination-container").on("click", "a.page-link", function (e) {
			e.preventDefault();
			const page = $(this).data("page");
			if (page && page !== currentPage && page >= 1 && page <= totalPages) {
				currentPage = page;
				fetchAttendanceData(currentPage, '', null, parseInt($("#jobLocationDropdown").val()) || 0);
			}
		});

		$(document).on("click", ".confirm-btn", function () {
			const $btn = $(this);
			const $cell = $(this).closest("tr");

			const status = $cell.find(".attendance-status-dropdown").val();
			const time = $cell.find(".attendance-time").val();
			const remarks = $cell.find(".attendance-remarks").val();
			const empId = $btn.data("empid");
			const empNo = $btn.data("empno");
			const workDate = $btn.data("datedata");

			if (!status) {
				alert("Please select a status before confirming.");
				$cell.find(".attendance-status-dropdown").focus();
				return;
			}

			const payload = {
				EmployeeIdEncrypted: empId,
				EmployeeNumber: empNo,
				Status: status,
				Time: time,
				Remarks: remarks,
				WorkDate: workDate
			};

			$btn.prop("disabled", true).text("Saving...");

			$.ajax({
				url: "/Employee/Attendance/SaveAttendanceStatus",
				method: "POST",
				data: payload,
				success: function (response) {
					if (response.data && response.data.pkNo > 0) {
						alert(response.data.message || "Attendance saved successfully.");
						location.reload();
					} else {
						alert("Failed to save attendance: " + (response.data?.message || "Unknown error."));
						$btn.prop("disabled", false).text("Confirm");
					}
				},
				error: function (xhr, status, error) {
					alert("An error occurred while saving attendance.");
					console.error(error);
					$btn.prop("disabled", false).text("Confirm");
				}
			});
		});

		$(document).on("click", "#bulk-upload-btn", function () {
			const payloadList = [];

			$("#attendance-data tr").each(function () {
				const $row = $(this);
				const status = $row.find(".attendance-status-dropdown").val();
				const time = $row.find(".attendance-time").val();
				const remarks = $row.find(".attendance-remarks").val();
				const empId = $row.find(".confirm-btn").data("empid");
				const empNo = $row.find(".confirm-btn").data("empno");
				const workDate = $row.find(".confirm-btn").data("datedata");

				if (status && empId && empNo && workDate) {
					payloadList.push({
						EmployeeIdEncrypted: empId,
						UserId: empNo,
						AttendanceStatus: status,
						DialerTime: time,
						Remarks: remarks,
						WorkDate: workDate
					});
				}
			});

			if (!payloadList.length) {
				alert("No rows with selected attendance status to save.");
				return;
			}

			$(this).prop("disabled", true).text("Saving...");

			$.ajax({
				url: "/Employee/Attendance/SaveBulkAttendanceStatus",
				method: "POST",
				contentType: "application/json",
				data: JSON.stringify(payloadList),
				success: function (response) {
					if (response.data && response.data.message === "Successfully saved attendance records.") {
						alert("Bulk attendance saved successfully.");
						location.reload();
					} else {
						alert("Failed: " + (response.data?.message || "Something went wrong."));
						$("#bulk-save-btn").prop("disabled", false).text("Bulk Save Attendance");
					}
				},
				error: function (xhr, status, error) {
					alert("Error while saving bulk attendance.");
					console.error(error);
					$("#bulk-save-btn").prop("disabled", false).text("Bulk Save Attendance");
				}
			});
		});
	});
</script>


